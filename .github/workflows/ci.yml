name: Continuous Integration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run nightly builds at 2 AM UTC
    - cron: '0 2 * * *'

env:
  BUILD_TYPE: Release
  QT_VERSION: 5.15.2

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format clang-tidy cppcheck
    
    - name: Check code formatting
      run: |
        find src -name "*.cpp" -o -name "*.h" | xargs clang-format --dry-run --Werror
    
    - name: Run static analysis
      run: |
        cppcheck --enable=all --std=c++17 --error-exitcode=1 src/
    
    - name: Check for TODO/FIXME comments
      run: |
        if grep -r "TODO\|FIXME" src/; then
          echo "Found TODO/FIXME comments. Please resolve before merging."
          exit 1
        fi

  build-linux:
    name: Build on Linux
    runs-on: ubuntu-latest
    needs: code-quality
    
    strategy:
      matrix:
        build_type: [Debug, Release]
        compiler: [gcc, clang]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        modules: 'qtcharts'
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          ninja-build \
          libgpiod-dev \
          pkg-config \
          lcov \
          valgrind
    
    - name: Setup compiler
      run: |
        if [ "${{ matrix.compiler }}" = "clang" ]; then
          sudo apt-get install -y clang
          echo "CC=clang" >> $GITHUB_ENV
          echo "CXX=clang++" >> $GITHUB_ENV
        fi
    
    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DBUILD_TESTS=ON \
          -DENABLE_COVERAGE=${{ matrix.build_type == 'Debug' && 'ON' || 'OFF' }} \
          -DENABLE_STATIC_ANALYSIS=ON \
          -DRASPBERRY_PI_OPTIMIZATIONS=OFF \
          -G Ninja
    
    - name: Build
      run: cmake --build build --config ${{ matrix.build_type }} -j$(nproc)
    
    - name: Run tests
      run: |
        cd build
        ctest --output-on-failure --parallel $(nproc)
    
    - name: Generate coverage report
      if: matrix.build_type == 'Debug' && matrix.compiler == 'gcc'
      run: |
        cd build
        lcov --capture --directory . --output-file coverage.info
        lcov --remove coverage.info '/usr/*' --output-file coverage.info
        lcov --list coverage.info
    
    - name: Upload coverage to Codecov
      if: matrix.build_type == 'Debug' && matrix.compiler == 'gcc'
      uses: codecov/codecov-action@v3
      with:
        file: build/coverage.info
        flags: unittests
        name: codecov-umbrella
    
    - name: Memory leak check
      if: matrix.build_type == 'Debug'
      run: |
        cd build
        valgrind --tool=memcheck --leak-check=full --error-exitcode=1 ./tests/SafetySystemTests

  build-raspberry-pi:
    name: Cross-compile for Raspberry Pi
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup cross-compilation environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc-aarch64-linux-gnu \
          g++-aarch64-linux-gnu \
          cmake \
          ninja-build
    
    - name: Install Qt for ARM64
      run: |
        # This would typically involve downloading Qt for ARM64
        # For now, we'll simulate the cross-compilation setup
        echo "Setting up Qt for ARM64 cross-compilation"
    
    - name: Configure for cross-compilation
      run: |
        cmake -B build-arm64 \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_TOOLCHAIN_FILE=cmake/arm64-toolchain.cmake \
          -DRASPBERRY_PI_OPTIMIZATIONS=ON \
          -DBUILD_TESTS=OFF \
          -G Ninja
    
    - name: Build for ARM64
      run: cmake --build build-arm64 --config Release -j$(nproc)
    
    - name: Package ARM64 build
      run: |
        cd build-arm64
        cpack -G DEB
    
    - name: Upload ARM64 package
      uses: actions/upload-artifact@v3
      with:
        name: vacuum-controller-arm64-deb
        path: build-arm64/*.deb

  documentation:
    name: Build Documentation
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Doxygen
      run: |
        sudo apt-get update
        sudo apt-get install -y doxygen graphviz
    
    - name: Build documentation
      run: |
        mkdir -p build
        cd build
        cmake .. -DBUILD_DOCS=ON
        make docs
    
    - name: Deploy documentation
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: build/docs/html
